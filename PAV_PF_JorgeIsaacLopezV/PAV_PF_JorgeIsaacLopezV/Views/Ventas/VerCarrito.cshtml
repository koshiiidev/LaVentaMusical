@model PAV_PF_JorgeIsaacLopezV.Models.ViewModels.CarritoViewModel
@using System.Linq

@{
    ViewBag.Title = "Carrito de compra";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var tarjetas = ViewBag.Tarjetas as SelectList;
}

<div class="page-header">
    <h2>Carrito de compra</h2>
</div>

@if (TempData["ErrorPago"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorPago"]
    </div>
}

@if (Model.Items == null || !Model.Items.Any())
{
    <div class="alert alert-info">
        No hay canciones en el carrito.
    </div>

    @Html.ActionLink("Ir a canciones", "Index", "Canciones", null, new { @class = "btn btn-primary" })
}
else
{
    <div class="row">
        <div class="col-md-8">
            <table class="table table-striped table-bordered">
                <tr>
                    <th>Canción</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th></th>
                </tr>

                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.NombreCancion</td>
                        <td>@item.Precio.ToString("C")</td>
                        <td>@item.Cantidad</td>
                        <td>@item.Subtotal.ToString("C")</td>
                        <td>
                            @Html.ActionLink(
                                "Eliminar",
                                "EliminarDelCarrito",
                                "Ventas",
                                new { idCancion = item.IdCancion },
                                new { @class = "btn btn-xs btn-danger" }
                            )
                        </td>
                    </tr>
                }
            </table>
        </div>

        <div class="col-md-4">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">Resumen de compra</h3>
                </div>
                <div class="panel-body">
                    <p><strong>Subtotal:</strong> @Model.Subtotal.ToString("C")</p>
                    <p><strong>IVA:</strong> @Model.Iva.ToString("C")</p>
                    <p><strong>Total:</strong> @Model.Total.ToString("C")</p>

                    <hr />

                    @using (Html.BeginForm("ConfirmarCompra", "Ventas", FormMethod.Post))
                    {
                        @Html.AntiForgeryToken()

                        <h4>Método de pago</h4>

                        if (tarjetas != null && tarjetas.Any())
                        {
                            <div class="form-group">
                                @Html.Label("idTipoTarjeta", "Tarjeta asociada")
                                @Html.DropDownList(
                                    "idTipoTarjeta",
                                    tarjetas,
                                    null,
                                    new { @class = "form-control" }
                                )
                            </div>

                            <button type="submit" class="btn btn-success btn-block">
                                Confirmar compra
                            </button>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                No tienes una tarjeta registrada. Debes completar tus datos de pago antes de realizar la compra.
                            </div>

                            @Html.ActionLink(
                                "Ir a mis datos",
                                "Edit",
                                "Usuarios",
                                new { id = Session["UsuarioId"] },
                                new { @class = "btn btn-primary btn-block" }
                            )
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}
